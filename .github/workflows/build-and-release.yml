name: Build and Release SmartEmailSender

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
          - os: macos-latest
            platform: macos
            arch: x64
          - os: macos-14
            platform: macos
            arch: arm64

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install system dependencies (Ubuntu)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libegl1-mesa \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          libgl1-mesa-glx

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        # ç¡®ä¿ç³»ç»Ÿä¾èµ–å®Œæ•´
        brew install --cask xquartz || true

    - name: Create build directory
      run: mkdir -p dist

    - name: Build with PyInstaller (Windows)
      if: matrix.platform == 'windows'
      run: |
        pyinstaller --clean ^
          --onefile ^
          --windowed ^
          --name SmartEmailSender ^
          --icon assets/SmartEmailSender.ico ^
          --collect-all PySide6 ^
          --collect-all shiboken6 ^
          --hidden-import PySide6.QtWebEngineWidgets ^
          --hidden-import PySide6.QtWebEngineCore ^
          --add-data "assets;assets" ^
          --add-data ".env.template;." ^
          src/SmartEmailSender.py

    - name: Build with PyInstaller (macOS/Linux)
      if: matrix.platform != 'windows'
      run: |
        pyinstaller --clean \
          --onefile \
          --windowed \
          --name SmartEmailSender \
          --icon assets/SmartEmailSender.icns \
          --collect-all PySide6 \
          --collect-all shiboken6 \
          --hidden-import PySide6.QtWebEngineWidgets \
          --hidden-import PySide6.QtWebEngineCore \
          --add-data "assets:assets" \
          --add-data ".env.template:." \
          src/SmartEmailSender.py

    - name: Create application bundle (macOS)
      if: matrix.platform == 'macos'
      run: |
        # åˆ›å»º .app åŒ…ç»“æ„
        mkdir -p "SmartEmailSender.app/Contents/MacOS"
        mkdir -p "SmartEmailSender.app/Contents/Resources"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/SmartEmailSender "SmartEmailSender.app/Contents/MacOS/"
        
        # å¤åˆ¶å›¾æ ‡
        cp assets/SmartEmailSender.icns "SmartEmailSender.app/Contents/Resources/"
        
        # åˆ›å»º Info.plist
        cat > "SmartEmailSender.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>SmartEmailSender</string>
            <key>CFBundleIconFile</key>
            <string>SmartEmailSender.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.company.smartemailsender</string>
            <key>CFBundleName</key>
            <string>SmartEmailSender</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.14</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSRequiresAquaSystemAppearance</key>
            <false/>
        </dict>
        </plist>
        EOF

    - name: Copy support tools to dist
      run: |
        # å¤åˆ¶æ”¯æŒå·¥å…·
        cp SmartEmailSender_åº”æ€¥æ–¹æ¡ˆ.py dist/ || echo "åº”æ€¥æ–¹æ¡ˆæ–‡ä»¶ä¸å­˜åœ¨"
        cp src/diagnostic_tool.py dist/ || echo "è¯Šæ–­å·¥å…·æ–‡ä»¶ä¸å­˜åœ¨"
        cp src/remote_support.py dist/ || echo "è¿œç¨‹æ”¯æŒå·¥å…·æ–‡ä»¶ä¸å­˜åœ¨"
        cp src/log_collector.py dist/ || echo "æ—¥å¿—æ”¶é›†å™¨æ–‡ä»¶ä¸å­˜åœ¨"

    - name: Create startup scripts
      run: |
        # Windows å¯åŠ¨è„šæœ¬
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cat > dist/å¯åŠ¨ç¨‹åº.bat << 'EOF'
        @echo off
        cd /d "%~dp0"
        echo ğŸš€ SmartEmailSender å¯åŠ¨å™¨
        echo ================================
        
        if not exist ".env" (
            echo é¦–æ¬¡è¿è¡Œï¼Œè¯·è¾“å…¥é…ç½®ä¿¡æ¯...
            set /p CLIENT_ID="Azure Client ID [b4741145-b380-4162-b6f8-53905c8068ec]: "
            set /p TENANT_ID="Azure Tenant ID [193a8985-443f-4477-92f3-2fb3a199095f]: "
            set /p TEST_EMAIL="æµ‹è¯•é‚®ç®±åœ°å€: "
            
            if "%CLIENT_ID%"=="" set CLIENT_ID=b4741145-b380-4162-b6f8-53905c8068ec
            if "%TENANT_ID%"=="" set TENANT_ID=193a8985-443f-4477-92f3-2fb3a199095f
            
            echo AZURE_CLIENT_ID=%CLIENT_ID%> .env
            echo AZURE_TENANT_ID=%TENANT_ID%>> .env
            echo TEST_SELF_EMAIL=%TEST_EMAIL%>> .env
            
            echo âœ… é…ç½®å·²ä¿å­˜ï¼
        )
        
        echo ğŸ”§ æ­£åœ¨å¯åŠ¨ SmartEmailSender...
        SmartEmailSender.exe
        
        if errorlevel 1 (
            echo âš ï¸ ä¸»ç¨‹åºå¯åŠ¨å¤±è´¥ï¼Œå°è¯•åº”æ€¥ç‰ˆæœ¬...
            if exist "SmartEmailSender_åº”æ€¥æ–¹æ¡ˆ.py" (
                python "SmartEmailSender_åº”æ€¥æ–¹æ¡ˆ.py"
            ) else (
                echo âŒ åº”æ€¥ç‰ˆæœ¬ä¸å¯ç”¨ï¼Œè¯·è”ç³»ITéƒ¨é—¨
                pause
            )
        )
        EOF
        fi
        
        # macOS/Linux å¯åŠ¨è„šæœ¬
        if [ "${{ matrix.platform }}" != "windows" ]; then
          cat > dist/å¯åŠ¨ç¨‹åº.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        
        echo "ğŸš€ SmartEmailSender å¯åŠ¨å™¨"
        echo "================================"
        
        if [ ! -f ".env" ]; then
            echo "é¦–æ¬¡è¿è¡Œï¼Œè¯·è¾“å…¥é…ç½®ä¿¡æ¯..."
            read -p "Azure Client ID [b4741145-b380-4162-b6f8-53905c8068ec]: " CLIENT_ID
            read -p "Azure Tenant ID [193a8985-443f-4477-92f3-2fb3a199095f]: " TENANT_ID
            read -p "æµ‹è¯•é‚®ç®±åœ°å€: " TEST_EMAIL
            
            CLIENT_ID=${CLIENT_ID:-b4741145-b380-4162-b6f8-53905c8068ec}
            TENANT_ID=${TENANT_ID:-193a8985-443f-4477-92f3-2fb3a199095f}
            
            cat > .env << ENVEOF
        AZURE_CLIENT_ID=$CLIENT_ID
        AZURE_TENANT_ID=$TENANT_ID
        TEST_SELF_EMAIL=$TEST_EMAIL
        ENVEOF
            echo "âœ… é…ç½®å·²ä¿å­˜ï¼"
        fi
        
        echo "ğŸ”§ æ­£åœ¨å¯åŠ¨ SmartEmailSender..."
        
        if [ "${{ matrix.platform }}" = "macos" ]; then
            if [ -d "SmartEmailSender.app" ]; then
                open SmartEmailSender.app
            else
                ./SmartEmailSender
            fi
        else
            ./SmartEmailSender
        fi
        
        if [ $? -ne 0 ] && [ -f "SmartEmailSender_åº”æ€¥æ–¹æ¡ˆ.py" ]; then
            echo "âš ï¸ ä¸»ç¨‹åºå¯åŠ¨å¤±è´¥ï¼Œå¯åŠ¨åº”æ€¥ç‰ˆæœ¬..."
            python3 "SmartEmailSender_åº”æ€¥æ–¹æ¡ˆ.py"
        fi
        EOF
          chmod +x dist/å¯åŠ¨ç¨‹åº.sh
        fi

    - name: Create README and documentation
      run: |
        cat > dist/README.md << 'EOF'
        # SmartEmailSender
        
        ä¸“ä¸šçš„æ‰¹é‡é‚®ä»¶å‘é€å·¥å…·ï¼Œæ”¯æŒExcelæ•°æ®å¯¼å…¥å’ŒMicrosoft 365é›†æˆã€‚
        
        ## å¿«é€Ÿå¼€å§‹
        
        ### Windowsç”¨æˆ·
        åŒå‡» `å¯åŠ¨ç¨‹åº.bat`
        
        ### macOSç”¨æˆ·
        åŒå‡» `å¯åŠ¨ç¨‹åº.sh` æˆ–æ‹–æ‹½ `SmartEmailSender.app` åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
        
        ### Linuxç”¨æˆ·
        è¿è¡Œ `./å¯åŠ¨ç¨‹åº.sh`
        
        ## é¦–æ¬¡é…ç½®
        - ç¨‹åºä¼šè‡ªåŠ¨æç¤ºè¾“å…¥Azureé…ç½®ä¿¡æ¯
        - é»˜è®¤å€¼å·²é¢„è®¾ç»„ç»‡é…ç½®
        - åªéœ€è¾“å…¥æ‚¨çš„æµ‹è¯•é‚®ç®±åœ°å€
        
        ## æ•…éšœå¤„ç†
        - ä¸»ç¨‹åºæ— æ³•å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°åº”æ€¥ç‰ˆæœ¬
        - è¿è¡Œ `diagnostic_tool.py` è¿›è¡Œç³»ç»Ÿè¯Šæ–­
        - è¿è¡Œ `remote_support.py` ç”ŸæˆæŠ€æœ¯æ”¯æŒåŒ…
        
        ## æŠ€æœ¯æ”¯æŒ
        å¦‚é‡é—®é¢˜è¯·è”ç³»ITéƒ¨é—¨å¹¶æä¾›è¯Šæ–­æŠ¥å‘Šã€‚
        EOF
        
        # åˆ›å»ºå®‰è£…è¯´æ˜
        cat > dist/å®‰è£…è¯´æ˜.txt << 'EOF'
        SmartEmailSender å®‰è£…è¯´æ˜
        =========================
        
        ğŸ“¦ ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 10+ / macOS 10.14+ / Ubuntu 18.04+
        - ç½‘ç»œè¿æ¥ï¼ˆç”¨äºAzure ADè®¤è¯ï¼‰
        
        ğŸš€ å®‰è£…æ­¥éª¤ï¼š
        1. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°ä»»æ„ç›®å½•
        2. åŒå‡»å¯åŠ¨è„šæœ¬å¼€å§‹ä½¿ç”¨
        3. é¦–æ¬¡è¿è¡Œæ—¶æŒ‰æç¤ºé…ç½®
        
        âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
        - è¯·å‹¿ç§»åŠ¨æˆ–åˆ é™¤ä»»ä½•æ–‡ä»¶
        - ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
        - macOSå¯èƒ½éœ€è¦åœ¨å®‰å…¨æ€§è®¾ç½®ä¸­å…è®¸è¿è¡Œ
        
        ğŸ”§ æ•…éšœå¤„ç†ï¼š
        - æŸ¥çœ‹ README.md äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•
        - è¿è¡Œè¯Šæ–­å·¥å…·æ£€æŸ¥é—®é¢˜
        - è”ç³»ITéƒ¨é—¨è·å¾—æŠ€æœ¯æ”¯æŒ
        EOF

    - name: Package artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        # åˆ›å»ºWindowså®‰è£…åŒ…ç›®å½•
        mkdir -p SmartEmailSender-Windows-${{ matrix.arch }}
        cp -r dist/* SmartEmailSender-Windows-${{ matrix.arch }}/
        
        # åˆ›å»ºZIPåŒ…
        powershell Compress-Archive -Path SmartEmailSender-Windows-${{ matrix.arch }} -DestinationPath SmartEmailSender-Windows-${{ matrix.arch }}.zip

    - name: Package artifacts (macOS)
      if: matrix.platform == 'macos'
      run: |
        # åˆ›å»ºmacOSåŒ…ç›®å½•
        mkdir -p SmartEmailSender-macOS-${{ matrix.arch }}
        cp -r dist/* SmartEmailSender-macOS-${{ matrix.arch }}/
        
        # ç§»åŠ¨ .app åˆ°åŒ…ç›®å½•
        if [ -d "SmartEmailSender.app" ]; then
          mv SmartEmailSender.app SmartEmailSender-macOS-${{ matrix.arch }}/
        fi
        
        # åˆ›å»ºDMGï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨zipï¼‰
        zip -r SmartEmailSender-macOS-${{ matrix.arch }}.zip SmartEmailSender-macOS-${{ matrix.arch }}

    - name: Package artifacts (Linux)
      if: matrix.platform == 'linux'
      run: |
        # åˆ›å»ºLinuxåŒ…ç›®å½•
        mkdir -p SmartEmailSender-Linux-${{ matrix.arch }}
        cp -r dist/* SmartEmailSender-Linux-${{ matrix.arch }}/
        
        # åˆ›å»ºtar.gzåŒ…
        tar -czf SmartEmailSender-Linux-${{ matrix.arch }}.tar.gz SmartEmailSender-Linux-${{ matrix.arch }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: SmartEmailSender-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          SmartEmailSender-*.zip
          SmartEmailSender-*.tar.gz
        retention-days: 30

  test:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-qt
        
    - name: Run tests
      run: |
        # è¿è¡ŒåŸºæœ¬å¯¼å…¥æµ‹è¯•
        python -c "
        try:
            import sys
            sys.path.insert(0, 'src')
            
            # æµ‹è¯•æ ¸å¿ƒæ¨¡å—å¯¼å…¥
            from graph.auth import GraphAuth
            from graph.api import GraphAPI
            print('âœ… æ ¸å¿ƒæ¨¡å—å¯¼å…¥æˆåŠŸ')
            
            # æµ‹è¯•åº”æ€¥ç‰ˆæœ¬
            exec(open('SmartEmailSender_åº”æ€¥æ–¹æ¡ˆ.py').read().replace('if __name__', 'if False and __name__'))
            print('âœ… åº”æ€¥ç‰ˆæœ¬è¯­æ³•æ£€æŸ¥é€šè¿‡')
            
            # æµ‹è¯•æ”¯æŒå·¥å…·
            if os.path.exists('src/diagnostic_tool.py'):
                exec(open('src/diagnostic_tool.py').read().replace('if __name__', 'if False and __name__'))
                print('âœ… è¯Šæ–­å·¥å…·è¯­æ³•æ£€æŸ¥é€šè¿‡')
                
        except Exception as e:
            print(f'âŒ æµ‹è¯•å¤±è´¥: {e}')
            sys.exit(1)
        "

  release:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
        
    - name: Create release notes
      run: |
        cat > release_notes.md << 'EOF'
        # SmartEmailSender Release
        
        ## ğŸš€ æ–°ç‰¹æ€§
        - ä¸“ä¸šæ‰¹é‡é‚®ä»¶å‘é€å·¥å…·
        - Excelæ•°æ®å¯¼å…¥æ”¯æŒ
        - Microsoft 365 Groupsé›†æˆ
        - å¯Œæ–‡æœ¬é‚®ä»¶ç¼–è¾‘
        - é™„ä»¶æ”¯æŒï¼ˆé€šç”¨å’Œä¸ªæ€§åŒ–ï¼‰
        - Azure ADå®‰å…¨è®¤è¯
        
        ## ğŸ”§ æŠ€æœ¯æ”¯æŒ
        - å®Œæ•´çš„æ•…éšœè¯Šæ–­å·¥å…·
        - åº”æ€¥å¤‡ç”¨æ–¹æ¡ˆ
        - è¿œç¨‹æŠ€æœ¯æ”¯æŒåŒ…ç”Ÿæˆ
        - è¯¦ç»†çš„æ•…éšœå¤„ç†æŒ‡å—
        
        ## ğŸ“¦ æ”¯æŒå¹³å°
        - Windows 10+ (x64)
        - macOS 10.14+ (x64, Apple Silicon)
        - Linux Ubuntu 18.04+ (x64)
        
        ## ğŸ¯ ä½¿ç”¨æ–¹æ³•
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
        2. è§£å‹åˆ°ä»»æ„ç›®å½•
        3. åŒå‡»å¯åŠ¨è„šæœ¬
        4. æŒ‰æç¤ºå®Œæˆé…ç½®
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡è¿è¡Œéœ€è¦ç½‘ç»œè¿æ¥è¿›è¡ŒAzure ADè®¤è¯
        - macOSç”¨æˆ·å¯èƒ½éœ€è¦åœ¨å®‰å…¨è®¾ç½®ä¸­å…è®¸è¿è¡Œ
        - å¦‚é‡é—®é¢˜è¯·è¿è¡Œè¯Šæ–­å·¥å…·æˆ–è”ç³»ITéƒ¨é—¨
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}